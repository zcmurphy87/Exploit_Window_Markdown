---
title: "CVEs: Analysis for Optimal Patch Deployment"
subtitle: "Interactive Analytic Dashboard"
author: "Zach Murphy, Shaheen Ghori, Aric Ward"
date: "5/16/2020"
runtime: shiny
output:
  html_document:
    code_folding: hide
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,message=FALSE,warning=FALSE,quiet=TRUE,progress=FALSE,fig.align='center')
library(readr)
library(plyr)
library(dplyr)
library(tidyr)
library(tidyverse)
library(RColorBrewer)
library(ggplot2)
library(lubridate)
library(shiny)
setwd("C:/Users/zach/Desktop/Graduate Programs/GMU/1. Spring 2020/AIT 664 - Info. Representation, Processing, and Visualization/ExploitWindow_InteractiveDashboard")

ExploitCVE <- read_csv("CVE_Exploit_Window.csv")
ExploitCVE <- transform(ExploitCVE, CVE_Date = as.Date(CVE_Date, format = "%m/%d/%Y"))
ExploitCVE <- transform(ExploitCVE, Date_Reported = as.Date(Date_Reported, format = "%m/%d/%Y"))

## CRATE MACRO VIEW SUMMARY TABLES ##
  # CVE Trends over time
ExploitCVE$CVS_Severity <- factor(ExploitCVE$CVS_Severity, levels=c("HIGH", "MEDIUM", "LOW"))

  # Create table
CVEBySeverity <- ExploitCVE %>%
  group_by(CVS_Severity, month=floor_date(CVE_Date, "month")) %>%
  tally()
```
### Video Presentation - https://youtu.be/BeDOHs3eCqA
## HYPOTHESIS
<ul>
<li> H1: The optimal timeframe to patch will be the shortest for vulnerabilities with severity rankings (CVSS scores) between 4-6
<li> H2: The timeframe between disclosure and exploit development has decreased over the past 10 years
<ul>
<ul><ul>

### ---------------------------------------------------------------------------
## METHODOLOGY
![](Exploit_Window_Methodology.png)

<ul><ul><ul><ul>
### ---------------------------------------------------------------------------

## RESULTS
### CVE Trends Over Time By Severity
The first implementation of our data set was intended to identify the severity of all CVEs in our data (see figure 5.1 below). We were able to collect, process, and analyze 96,416 unique vulnerabilities between 2010 and 2019 (see figure 5.2 below). These numbers consistently show that most CVEs identified throughout the years are of MEDIUM severity (53,296), followed by HIGH (27,240), and then finally LOW (8,741). This helps us understand that the correlation previously identified by other researchers throughout the course of our literature review that “most exploited vulnerabilities are MEDIUM or HIGH” is perhaps an obvious statement to make, as these two categories represent 83.5297% of all vulnerabilities.
```{r, MacroGraphAll, echo=FALSE}
  # Create bar plots
# CVEBySeverityPlot <- ggplot(CVEBySeverity, aes(x=month, y=n, fill=CVS_Severity)) + geom_bar(stat="identity") + scale_x_date(date_breaks = "year") +
# labs(title = "CVE Trends Over Time", x = "CVE Date", y = "# of CVEs by Month",
#       subtitle = "2010 - 2019", fill="CVS Severity") +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# CVEBySeverityPlot
```


```{r, MacroGraphManipulatable, echo=FALSE}
selectInput("Severity_Selection", label = "Severity:",
            choices = unique(CVEBySeverity$CVS_Severity), 
            selected = unique(CVEBySeverity$CVS_Severity)[1])

renderPlot(ggplot(subset(CVEBySeverity, CVS_Severity %in% input$Severity_Selection),
                            aes(x=month, y=n, fill=CVS_Severity)) +
  geom_bar(stat="identity") + stat_smooth(color = "blue") +
  scale_x_date(date_breaks = "year") +
  labs(title = "CVE Trends Over Time", x = "CVE Date", y = "# of CVEs by Month", 
       subtitle = "2010 - 2019") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)))
```


### With Zero Days - Exploitation Window By Severity
As we review the exploit windows for all CVEs (including zero-days) over time, we see a consistent trend line of vulnerabilities taking longer to exploit, with a turning point around the mid-point of 2012. Though we were able to identify some potential reasons why we see this shift, such as the bipartisan Cybersecurity Act of 2012 and what appears to be an increase in non-malware-based cyber attacks, this phenomenon certainly requires further research. When we filter out zero-day vulnerabilities, we see almost the exact opposite being true. Over the years, we see non-zero-day vulnerabilities being exploited faster. There was a sharp decrease in exploit windows between 2016 and 2017, with the total difference in exploit windows between 2010 and 2019 being more than 100 days. There is an intersection between the exploit window in 2019 and our 30-day exploit window filter, further bolstering our claim that the optimal time for exploitation based on all analyzed data appears to be nine days. 
```{r, WithZeroDaysAll, echo=FALSE}
# Exploit Window over Time With zero days included
# get months
ExploitCVE$Month <- months(ExploitCVE$Date_Reported)

#  Get year and month columns and averages
ExploitCVE$Year <- format(ExploitCVE$Date_Reported,format="%Y")
ExpWindByTime <- aggregate( Exploit_Window ~ Month+Year+CVS_Severity , ExploitCVE , mean )
ExpWindByTime$Month <- factor(ExpWindByTime$Month, levels=c("January", "February", "March",
 "April", "May", "June", "July", "August", "September", "October", "November", "December"))

ExpWindByTime <- ExpWindByTime %>%
  mutate(Day = 1) %>%
  group_by(Year, Month)

ExpWindByTime <- ExpWindByTime %>% 
  mutate(Date = as.Date(paste(Year, Month, Day,sep="-"), "%Y-%B-%d"))

# Create plot for total
# AVGExploitWindowPlot <- ggplot(ExpWindByTime, aes(x=Date, y=Exploit_Window, fill="Total")) + geom_line(color = "red") + stat_smooth(color = "blue") +
#  scale_x_date(date_breaks = "year") +
#  labs(title = "Average Exploit Window Over Time - With Zero Days Included", x = "Time", y = "AVG # of Days to Exploit a CVE", 
#       subtitle = "2010 - 2019", fill="CVE Severity") +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# AVGExploitWindowPlot
```


```{r, WithZeroDaysSelectable, echo=FALSE}
selectInput("Severity_Selection2", label = "Severity:",
            choices = unique(CVEBySeverity$CVS_Severity)) 

# Create plot for each severity (selectable)
renderPlot(ggplot(subset(ExpWindByTime, CVS_Severity %in% input$Severity_Selection2),
                         aes(x=Date, y=Exploit_Window, color=CVS_Severity)) +
  geom_line(stat="identity") + stat_smooth(color = "blue") +
  scale_x_date(date_breaks = "year") +
  labs(title = "Average Exploit Window By Month - With Zero Days Included", x = "Time", y = "AVG # of Days to Exploit a CVE", 
       subtitle = "2010 - 2019", fill="CVE Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)))
```

### Without Zero Days - Exploitation Window By Severity
We further examine the vulnerabilities by their severity each year to determine what the optimal timeframe to patch is based on our observed 30-day filter from previous iterations of testing. This measure is meant to help satisfy our hypothesis. When reviewing these non-zero-day exploited vulnerabilities we find that there is a consistent, slowly paced downward trend in exploits (see figure 5.8 below). We also find that our hypothesis holds true, the average across these vulnerabilities indicates that MEDIUM ranked vulnerabilities are exploited faster on average than HIGH or LOW vulnerabilities. Another interesting intersection also occurs here, where the average across these exploits windows by year, by severity, is also 9 days.
```{r, WithoutZeroDaysAll, echo=FALSE}
ExploitCVE_NoZero <- read_csv("CVE_Exploit_Window_NoZeroDays.csv")

# Change date columns to date type
ExploitCVE_NoZero <- transform(ExploitCVE_NoZero, CVE_Date = as.Date(CVE_Date, format = "%m/%d/%Y"))
ExploitCVE_NoZero <- transform(ExploitCVE_NoZero, Date_Reported = as.Date(Date_Reported, format = "%m/%d/%Y"))

## Exploit Window over Time Without zero days - by month ##
ExploitCVE_NoZero$Month <- months(ExploitCVE_NoZero$Date_Reported)             # get month column from date 
ExploitCVE_NoZero$Year <- format(ExploitCVE_NoZero$Date_Reported,format="%Y")  # get year col from date 

  # get average exploit window grouped by month and year
ExpWindByTime_NoZero <- aggregate(Exploit_Window ~ Month+Year+CVS_Severity, ExploitCVE_NoZero, mean)

  # Order values for month column
ExpWindByTime_NoZero$Month <- factor(ExpWindByTime_NoZero$Month, levels=c("January", "February", "March",
              "April", "May", "June", "July", "August", "September", "October", "November", "December"))

  # Create summary table - by month
ExpWindByTime_NoZero <- ExpWindByTime_NoZero %>%
  mutate(Day = 1) %>%
  group_by(Year, Month) # make each day of the month "1" so we can plot by month

ExpWindByTime_NoZero <- ExpWindByTime_NoZero %>% 
  mutate(Date = as.Date(paste(Year, Month, Day,sep="-"), "%Y-%B-%d")) # reformat date column

  # Create line plot - By Month
# AVGExploitWindowPlot_NoZero <- ggplot(ExpWindByTime_NoZero, aes(x=Date, y=Exploit_Window, fill = "Total")) + geom_line(color = "red") + stat_smooth(color = "blue") + scale_x_date(date_breaks = "year") +
#  labs(title = "Average Exploit Window by Month - Without Zero Days", x = "Time", y = "AVG # of Days to Exploit a CVE", 
#       subtitle = "2010 - 2019", fill="CVE Severity") +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# AVGExploitWindowPlot_NoZero
```


```{r, WithoutZeroDaysSelectable, echo=FALSE}
selectInput("Severity_Selection3", label = "Severity:",
            choices = unique(CVEBySeverity$CVS_Severity)) 

# Create plot
renderPlot(ggplot(subset(ExpWindByTime_NoZero, CVS_Severity %in% input$Severity_Selection3),
                         aes(x=Date, y=Exploit_Window, color=CVS_Severity)) +
  geom_line(stat="identity") + stat_smooth(color = "blue") +
  scale_x_date(date_breaks = "year") +
  labs(title = "Average Exploit Window by Month - Without Zero Days", x = "Time", y = "AVG # of Days to Exploit a CVE", 
       subtitle = "2010 - 2019", fill="CVE Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)))
```

<ul>
<ul>
<ul>
<ul> 
### ---------------------------------------------------------------------------
## CONCLUSION
Our research team set out to understand what the optimum time is to patch vulnerabilities. We used iterative, easily repeatable methods to collect, process, and analyze over 95,000 vulnerabilities and their associated exploits between 2010 and 2019. On average, we find that there are 88 days between patch availability and exploit in non-zero-day cases. As we begin to filter that down to usable context, that window drops to roughly 9 days on a month-to-month basis. We posit that security organizations that want to be best protected from vulnerability exploits should develop a patch management cycle that can be completed no later than 9 days after a patch is released. We expect, that moving forward, the exploitation window will continue to shrink on a year-by-year basis to smaller numbers while the overall window grows given older vulnerabilities being exploited in attacks. This assessment does not necessarily mean that security organizations can be lazy in their patch management processes, due diligence must be performed to minimize the effect of exploited vulnerabilities (especially those that have had patches available for quite some time).







